/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package ca.robokids.robooffice.desktop.tabs.finance.components;

import ca.robokids.exception.DatabaseException;
import ca.robokids.robooffice.entity.finance.Tax;
import ca.robokids.robooffice.logic.finance.TaxManager;
import java.text.NumberFormat;
import java.util.List;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.DefaultComboBoxModel;

/**
 *
 * @author Coldsoft
 */

public class SubtotalPanel extends javax.swing.JPanel {

   /**
    * Creates new form SubtotalPanel
    */
   //Currency formator, float to String
   private NumberFormat cf = NumberFormat.getCurrencyInstance();

   private float rate;
   private float amount;

   DefaultComboBoxModel<Tax> taxModel = new DefaultComboBoxModel();
   public SubtotalPanel(float rate, float amount, boolean tax) {
      
      initComponents();
      this.rate = rate;
      this.amount = amount;
      initTax(tax);
      
      if(rate < 0)
      {
         lblDiscountClass.setEnabled(false);
         spinDiscountClass.setEnabled(false);
         lblRate.setEnabled(false);
      }
      
      updateFields();
   }

   public void setAmount(float amount) {
      this.amount = amount;
      updateFields();
   }
   
   
   /**
    * This method is called from within the constructor to initialize the form.
    * WARNING: Do NOT modify this code. The content of this method is always
    * regenerated by the Form Editor.
    */
   @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        lblDiscountClass = new javax.swing.JLabel();
        spinDiscountClass = new com.toedter.components.JSpinField();
        jLabel2 = new javax.swing.JLabel();
        jScrollPane1 = new javax.swing.JScrollPane();
        txtDiscountReason = new javax.swing.JTextArea();
        jLabel3 = new javax.swing.JLabel();
        txtDiscountAmount = new ca.robokids.robooffice.desktop.tabs.components.CurrencyJTextField();
        jSeparator1 = new javax.swing.JSeparator();
        jLabel4 = new javax.swing.JLabel();
        lblAmount = new javax.swing.JLabel();
        jLabel6 = new javax.swing.JLabel();
        lblDiscount = new javax.swing.JLabel();
        jLabel8 = new javax.swing.JLabel();
        cboTax = new javax.swing.JComboBox();
        jLabel9 = new javax.swing.JLabel();
        lblSubtotal = new javax.swing.JLabel();
        lblRate = new javax.swing.JLabel();

        lblDiscountClass.setText("Discount Class:");

        spinDiscountClass.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusLost(java.awt.event.FocusEvent evt) {
                spinDiscountClassFocusLost(evt);
            }
        });
        spinDiscountClass.addPropertyChangeListener(new java.beans.PropertyChangeListener() {
            public void propertyChange(java.beans.PropertyChangeEvent evt) {
                spinDiscountClassPropertyChange(evt);
            }
        });

        jLabel2.setText("Discount Reason:");

        txtDiscountReason.setColumns(20);
        txtDiscountReason.setLineWrap(true);
        txtDiscountReason.setRows(3);
        jScrollPane1.setViewportView(txtDiscountReason);

        jLabel3.setText("Discount Amount $");

        txtDiscountAmount.setText("0");
        txtDiscountAmount.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                txtDiscountAmountActionPerformed(evt);
            }
        });
        txtDiscountAmount.addFocusListener(new java.awt.event.FocusAdapter() {
            public void focusLost(java.awt.event.FocusEvent evt) {
                txtDiscountAmountFocusLost(evt);
            }
        });
        txtDiscountAmount.addPropertyChangeListener(new java.beans.PropertyChangeListener() {
            public void propertyChange(java.beans.PropertyChangeEvent evt) {
                txtDiscountAmountPropertyChange(evt);
            }
        });

        jLabel4.setText("Total amount");

        lblAmount.setText("jLabel5");

        jLabel6.setText("Discount");

        lblDiscount.setText("jLabel7");

        jLabel8.setText("Tax");

        cboTax.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "Item 1", "Item 2", "Item 3", "Item 4" }));

        jLabel9.setText("Subtotal");

        lblSubtotal.setText("jLabel10");

        lblRate.setText("jLabel5");

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(jLabel2)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jScrollPane1))
            .addComponent(jSeparator1)
            .addGroup(layout.createSequentialGroup()
                .addComponent(lblDiscountClass)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(spinDiscountClass, javax.swing.GroupLayout.PREFERRED_SIZE, 35, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(lblRate, javax.swing.GroupLayout.PREFERRED_SIZE, 46, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 35, Short.MAX_VALUE)
                .addComponent(jLabel3)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(txtDiscountAmount, javax.swing.GroupLayout.PREFERRED_SIZE, 47, javax.swing.GroupLayout.PREFERRED_SIZE))
            .addGroup(layout.createSequentialGroup()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jLabel6, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jLabel4, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jLabel8, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jLabel9, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addComponent(lblAmount, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(lblDiscount, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(cboTax, 0, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(lblSubtotal, javax.swing.GroupLayout.PREFERRED_SIZE, 144, javax.swing.GroupLayout.PREFERRED_SIZE)))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addComponent(spinDiscountClass, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(lblDiscountClass, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                        .addComponent(jLabel3)
                        .addComponent(txtDiscountAmount, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addComponent(lblRate, javax.swing.GroupLayout.PREFERRED_SIZE, 20, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jLabel2)
                    .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(jSeparator1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel4)
                    .addComponent(lblAmount))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel6)
                    .addComponent(lblDiscount))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel8)
                    .addComponent(cboTax, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 22, Short.MAX_VALUE)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jLabel9)
                    .addComponent(lblSubtotal)))
        );
    }// </editor-fold>//GEN-END:initComponents

   private void txtDiscountAmountFocusLost(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_txtDiscountAmountFocusLost
      updateFields();
   }//GEN-LAST:event_txtDiscountAmountFocusLost

   private void txtDiscountAmountActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_txtDiscountAmountActionPerformed
      updateFields();
   }//GEN-LAST:event_txtDiscountAmountActionPerformed

   private void txtDiscountAmountPropertyChange(java.beans.PropertyChangeEvent evt) {//GEN-FIRST:event_txtDiscountAmountPropertyChange
      updateFields();
   }//GEN-LAST:event_txtDiscountAmountPropertyChange

   private void spinDiscountClassFocusLost(java.awt.event.FocusEvent evt) {//GEN-FIRST:event_spinDiscountClassFocusLost
      updateFields();
   }//GEN-LAST:event_spinDiscountClassFocusLost

   private void spinDiscountClassPropertyChange(java.beans.PropertyChangeEvent evt) {//GEN-FIRST:event_spinDiscountClassPropertyChange
      updateFields();
   }//GEN-LAST:event_spinDiscountClassPropertyChange

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JComboBox cboTax;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JLabel jLabel8;
    private javax.swing.JLabel jLabel9;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JSeparator jSeparator1;
    private javax.swing.JLabel lblAmount;
    private javax.swing.JLabel lblDiscount;
    private javax.swing.JLabel lblDiscountClass;
    private javax.swing.JLabel lblRate;
    private javax.swing.JLabel lblSubtotal;
    private com.toedter.components.JSpinField spinDiscountClass;
    private ca.robokids.robooffice.desktop.tabs.components.CurrencyJTextField txtDiscountAmount;
    private javax.swing.JTextArea txtDiscountReason;
    // End of variables declaration//GEN-END:variables

   private void updateFields() {
      
      
      //set initial amount
      lblAmount.setText(cf.format(amount));
      
      //get discount amount
      float discountAmount;
      try{
         discountAmount = Float.valueOf(txtDiscountAmount.getText());
      }catch(Exception ex)
      {
         ex.printStackTrace();
         discountAmount = 0;
      }
      
      // if not discount , disable discount reason text box
      if (spinDiscountClass.getValue() <= 0 && discountAmount <= 0)
      {
         txtDiscountReason.setText("");
         txtDiscountReason.setEnabled(false);
         
      }else
      {
         txtDiscountReason.setEnabled(true);
      }
      
      //total discount calculation
      float discount = spinDiscountClass.getValue() * rate + discountAmount;
      lblDiscount.setText(cf.format(discount));
      
      //get tax
      int index = cboTax.getSelectedIndex();
      Tax tax = taxModel.getElementAt(index);
      
      //calculate total
      float subtotal =  ( amount - discount ) * ( 1 + tax.getTaxPercentage());
      lblSubtotal.setText(cf.format(subtotal));
   }



   private void initTax(boolean tax) {
      List<Tax> list  = null;
      taxModel.removeAllElements();
      try {
         list = TaxManager.loadAllTax();
      } catch (DatabaseException ex) {
         Logger.getLogger(SubtotalPanel.class.getName()).log(Level.SEVERE, null, ex);
      }
      
      for (Tax t : list)
      {
         taxModel.addElement(t);
      }
      
      if (taxModel.getSize() > 0)
         cboTax.setSelectedIndex(0);
   }
    
    

}
